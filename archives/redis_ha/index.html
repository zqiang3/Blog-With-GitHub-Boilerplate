<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="君祁,blog" />
    <meta name="generator" content="Maverick 1.1" />
    <meta name="template" content="Kepler" />
    <link rel="alternate" type="application/rss+xml" title="君祁的技术博客 &raquo; RSS 2.0" href="/Blog-With-GitHub-Boilerplate/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="君祁的技术博客 &raquo; ATOM 1.0" href="/Blog-With-GitHub-Boilerplate/feed/atom/index.xml" />
    <link rel="stylesheet" href="/Blog-With-GitHub-Boilerplate/assets/kepler-426969802d.css">
    <link rel="stylesheet" href="/Blog-With-GitHub-Boilerplate/assets/ExSearch/ExSearch-182e5a8868.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.10.0/dist/tocbot.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "/Blog-With-GitHub-Boilerplate/ff7a3d08ab16b8619895bb8b720f4bc8.json"
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            if(/Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)){
                document.body.classList.add('safari')
            }else{
                document.body.classList.remove('safari')
            }
        });
    </script>
    
<title>redis高可用 - 君祁的技术博客</title>
<meta name="author" content="君祁" />
<meta name="description" content="redis高可用" />
<meta property="og:title" content="redis高可用 - 君祁的技术博客" />
<meta property="og:description" content="redis高可用" />
<meta property="og:site_name" content="君祁的技术博客" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/Blog-With-GitHub-Boilerplate/archives/redis_ha/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2021-06-24T01:00:23-00.00" />
<meta name="twitter:title" content="redis高可用 - 君祁的技术博客" />
<meta name="twitter:description" content="redis高可用" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />

    </head>
    
    <body class="content">
        <header>
            <div class="container">
                <section>
                    <a href="/Blog-With-GitHub-Boilerplate/"><img src="/Blog-With-GitHub-Boilerplate/logo.png">君祁的技术博客</a>
                </section>
                <section>
                    <nav>
                        <ul>
                            
                                <li><a href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick</a></li>
                            
                                <li><a href="https://github.com/zqiang3" target="_blank">github</a></li>
                            
                        </ul>
                    </nav>
                </section>
    
                <section>
                    <a hidden class="toggle-toc" target="_self" href="javascript:void(0)" onclick="$(body).toggleClass('toc-open')"><i class="fa fa-align-right"></i></a>
                    <a hidden class="toggle-navbar" target="_self" href="javascript:void(0)" onclick="$(body).toggleClass('navbar-open')"><i class="fa fa-indent"></i></a>
                    <button class="search-form-input"><i class="fa fa-search"></i></button>
                </section>
            </div>
        </header>

        <main>
            <div id="pjax-container" class="container">
                <aside id="navbar" class="no-scrollbar">
                    
                    <section class="sidebar-nav">
                        
                            <div class="None" ><span><a href="/Blog-With-GitHub-Boilerplate/">首页</a></span></div>
                        
                            <div class="None" ><span><a href="/Blog-With-GitHub-Boilerplate/archives/">归档</a></span></div>
                        
                            <div class="None" ><span><a href="/Blog-With-GitHub-Boilerplate/about/">关于</a></span></div>
                        
                    </section>
                    
                    <section>
                        
    <div class=" "><span><a href="/Blog-With-GitHub-Boilerplate/category/architecture/">architecture</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/live_architecture/">多活架构分析</a></li></ul></div><div class="open "><span><a href="/Blog-With-GitHub-Boilerplate/category/Maverick/">Maverick</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/health_habbit/">健康习惯</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/ddd/">领域驱动设计</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/blog_template/">blog_template</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/consistency/">一致性问题</a></li><li class="current"><a href="/Blog-With-GitHub-Boilerplate/archives/redis_ha/">redis高可用</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/redis/">redis设计与实现</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/message_queue/">消息队列</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/system_design/">系统设计</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/typography/">Hello World!</a></li></ul></div><div class=" "><span><a href="/Blog-With-GitHub-Boilerplate/category/容器技术/">容器技术</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/docker_resource/">docker资源</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/docker_commands/">docker commands</a></li></ul></div><div class=" "><span><a href="/Blog-With-GitHub-Boilerplate/category/algorithm/">algorithm</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/algorithm_summary/">算法套路总结</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/binary_tree/">二叉树的前中后序遍历</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/binary_search/">二分查找</a></li></ul></div><div class=" "><span><a href="/Blog-With-GitHub-Boilerplate/category/数据库/">数据库</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/mysql_ha/">MySQL高可用</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/mysql_index/">数据库锁</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/mysql_index/">谈谈数据库的索引</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/mysql/">MySQL</a></li></ul></div><div class=" "><span><a href="/Blog-With-GitHub-Boilerplate/category/Java/">Java</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/java_function_program/">聊聊Java8的函数式编程</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/hashmap/">HashMap的实现原理</a></li></ul></div><div class=" "><span><a href="/Blog-With-GitHub-Boilerplate/category/网络/">网络</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/http/">HTTP</a></li><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/tcp/">TCP</a></li></ul></div><div class=" "><span><a href="/Blog-With-GitHub-Boilerplate/category/MySQL/">MySQL</a><button class="toggle_sidebar fa"></button></span><ul><li class=""><a href="/Blog-With-GitHub-Boilerplate/archives/mysql_lock/">MySQL锁</a></li></ul></div>

                    </section>
                    <section hidden class="sidebar-external-link">
                        
                            <div class="external"><span><a href="https://github.com/AlanDecode/Maverick">Maverick</a><button class="go-external"><i class="fa fa-external-link"></i></button></span></div>
                        
                            <div class="external"><span><a href="https://github.com/zqiang3">github</a><button class="go-external"><i class="fa fa-external-link"></i></button></span></div>
                        
                    </section>
                    <section class="maverick">
                        <div><span style="border: 1px solid #d4dadf;"><a href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Kepler</a></span></div>
                    </section>
                </aside>
                <div id="content-wrapper">
                    <div id="content">
    <section>
        <h1 class="post-title">redis高可用</h1>
        <p class="post-meta">
            <time>June 24 2021</time>
            <span class="tags">
                
                <span>
                    <a href="/Blog-With-GitHub-Boilerplate/tag/redis/">#redis</a>
                </span>
                
                <span>
                    <a href="/Blog-With-GitHub-Boilerplate/tag/ha/">#ha</a>
                </span>
                
            </span>
        </p>
        <article class="yue"><h2>过期删除策略</h2>
<p><a href="https://zhuanlan.zhihu.com/p/139423463">链接</a></p>
<ul>
<li>定时删除</li>
</ul>
<p>在设置键的过期时间的同时，创建一个定时器，定时器在键过期时，立即执行对键的删除操作。定时删除可以保证键尽快地被删除，释放占用的空间。</p>
<p>对内存友好，对cpu非常不友好。创建大量的定时器消耗大量的时间处理键的过期删除，服务器处理命令请求的性能就会降低。目前redis没有使用定时删除策略。</p>
<ul>
<li>惰性删除</li>
</ul>
<p>当访问键时，才去检查键是否过期，如果过期就删除键，如果没有过期就返回该键。</p>
<ul>
<li>定期删除</li>
</ul>
<p>每隔一段时间，就对数据库进行一次检查，查看哪些键过期，再根据具体策略决定删除哪些键。</p>
<p>定期删除策略每隔一段时间对键执行过期删除，并通过限制执行删除的时长和频率来减少对cpu的性能影响。</p>
<h3>redis使用的过期删除策略</h3>
<p>redis使用的是惰性删除和定期删除策略。</p>
<p>定期删除的流程为，周期性地执行定期删除函数，每次随机从数据库取出一定数量的键进行检查，并删除其中的过期键。随机删除key的算法，可能是LRU算法。</p>
<h3>RDB对过期键的处理</h3>
<p>生成RDB文件时，不会包含过期的键。执行SAVE或BGSAVE命令时，会对键进行检查，已过期的键不会被保存在新创建的RDB文件中。</p>
<p>载入RDB文件时，主服务器中已过期的键不会被载入内存，从服务器会将所有键载入内存。</p>
<h3>AOF对过期键的处理</h3>
<p>如果服务器开启了AOF持久化功能，当键过期被删除时，redis会追加一条DEL命令到AOF文件中，显示标记该键已被删除。</p>
<p>当执行AOF重写时，已过期的键不会被保存在重写后的AOF文件中。</p>
<h3>主从复制对过期键的处理</h3>
<p>从服务器不会触发键过期，而是会等待主节点触发键过期。主节点键过期时，会同步del命令给所有的从节点。
从节点不处理过期键，但也不会返回已过期的数据，会通过独有的逻辑来标记一个键已经过期。</p>
<h2>主从模式</h2>
<p><strong>主从复制的过程</strong></p>
<ol>
<li>主节点(master)开启一个子进程，生成rdb快照文件，同时将新的命令写到缓冲区</li>
<li>向从节点(slave)发送rdb快照文件</li>
<li>从节点收到rdb文件后，加载数据到内存</li>
<li>主节点再将缓冲区命令发到从节点，加载后与主节点达到一致状态</li>
<li>之后主节点每收到一个新的写命令，都会同步给从节点</li>
</ol>
<p>主从复制开始时，副本从主机全量同步数据，发送psync命令，主机执行bgsave，在后台开启一个子进程产生rdb文件，同时将后面新的写命令写到一个缓冲区，然后把rdb文件发送给从机，从机收到后load到内存，这个步骤完成后主机再将缓冲区的数据发给从机，再之后主机收到新的写命令，都会发给从机</p>
<p>master如果发现有多个slave node都来重新连接，仅仅会启动一个rdb save操作，用一份数据服务所有slave node。</p>
<p>增量同步条件：主机会维护一个复制积压缓冲区，如果从节点缺失的数据在复制积压缓冲区内，可以执行增量同步，否则执行全量同步。</p>
<p>复制积压缓冲区是一个固定长度的先进先出队列，默认大小为1M。</p>
<p><strong>缺点</strong></p>
<ol>
<li>主库执行全量备份会造成毫秒或秒级的卡顿</li>
<li>COW机制，极端情况下主库内存溢出，程序异常退出或宕机</li>
<li>发送数GB大小的备份文件导致服务器出口带宽暴增，阻塞请求。</li>
<li>需要人为手工操作，需要通知业务方做变更配置，整个过程需要人为干预，较为烦琐</li>
</ol>
<p>在主-从模式里，如果主服务器宕机了，虽然可以由从机来代替主机继续服务，但这需要人工把从机切换成主机，需要人工干预，还会造成一段时间服务不可用。</p>
<p><strong>异步复制</strong>
Redis的主从复制是异步复制，异步分为两个方面，一个是master服务器在将数据同步到slave是异步的，一个是slave在接收同步数据时也是异步的。</p>
<p>主从复制的模式是异步复制的，主向从发送数据后就返回了，并不等待从成功写入数据。异步复制会导致数据的一致性较差，可能会产生数据丢失。</p>
<h2>sentinel</h2>
<p>Sentinel是Redis的高可用性解决方案。</p>
<p><strong>故障转移的过程</strong></p>
<ol>
<li>每个sentinel根据心跳响应超时判断主节点是否主观下线，根据配置判定是否客观下线。sentinel判定下线的标准是写在配置里的，包括多久超时，其他sentinel认为下线的数量。</li>
<li>选举领头sentinel，在每个纪元周期，每个sentinel都可以发送广播让其他sentinel设置自己为领头sentinel；每个sentinel有一次机会设置另一个sentinel为leader；
当某个sentinel获得了半数以上的选票，就成为leader，并发送广播告诉其他sentinel，选举阶段结束。</li>
<li>领头sentinel选择一台从服务器，将其升级为主服务器。选取的标准有几个。</li>
<li>向其他从服务器发送命令，让它们复制新的主服务器</li>
<li>当旧的主服务器重新连线后，将成为新的主服务器的从服务器</li>
</ol>
<p>选取从服务器升级为主服务器的标准：</p>
<ol>
<li>删除所有下线或断线的从服务器</li>
<li>删除最近5秒没有回复info命令的从服务器</li>
<li>删除与主服务器断开超过一定时间的从服务器，保证数据是相对较新的</li>
<li>选择优先级最高的</li>
<li>选择复制偏移量最大的</li>
</ol>
<p><strong>sentinel的启动过程</strong></p>
<ul>
<li>每个sentinel都与主服务器建立命令连接和订阅连接。命令连接可以发送info命令，发送publish命令，订阅连接可以接收hello频道的信息</li>
<li>与主服务器建立连接后，可以向主服务器发送info命令，可以得到从服务器的信息。sentinel就可以无需用户提供从服务器的信息，可以通过主服务器发现从服务器</li>
<li>发现从服务器后，创建与从服务器的命令连接和订阅连接，也可以向从服务器发送info命令了</li>
<li>sentinel通过hello频道的信息可以自动发现其他sentinel，相互之间建立命令连接，不建议订阅连接</li>
</ul>
<h2>Redis Cluster</h2>
<p>Redis Cluster是Redis提供的<strong>分布式集群</strong>解决方案，集群通过分片来进行数据共享，并提供复制和故障转移功能。</p>
<p>通过Gossip协议进行通信。</p>
<p>最小配置6个节点以上（3主3从），主节点提供读写操作，从节点作为备用节点，不提供服务，只作为故障转移使用。节点只使用0号数据库</p>
<p>关键词：节点、槽指派、命令执行、重新分片、转向、故障转移、消息。</p>
<p><strong>故障转移</strong></p>
<p>集群中的每个节点都会定期地向其他节点发送ping消息，以此来检测对方是否在线。如果接收ping消息的节点没有在规定的时间之内回复pong，就会被标记为<strong>疑似下线</strong>。节点的状态包括：在线，疑似下线，已下线。</p>
<ol>
<li>如果集群里半数以上的负责处理槽的主节点将某个主节点报告为疑似下线，则该节点将被标记为<strong>已下线</strong>。</li>
<li>第一个标记节点为已下线的主节点将向集群广播一条消息，所有收到消息的节点也会立即标记该节点已下线。</li>
<li>从已下线的主节点下选中一个从节点，使其成为新的主节点。</li>
<li>新的主节点接管所有旧的主节点的槽，指派给自己。</li>
<li>向集群广播一条消息，告诉其他节点自己已成为新的主节点，并接管了所有的槽。</li>
<li>新的主节点开始接收命令和处理自己负责的槽，故障转移完成。</li>
</ol>
<p><strong>选举新的主节点的过程</strong></p>
<ol>
<li>所有的主节点有投票权，从节点没有投票权</li>
<li>在某个主节点已下线后，其下的从节点会向集群广播一条消息，要求收到消息的主节点向自己投票。</li>
<li>每个在线的主节点都有一次投票机会，会选择最先向自己要求投票的从节点。</li>
<li>当某个从节点获得了半数以上的投票，则选举成功；否则，任何一个从节点都没有获得足够多的选票，会在新的纪元周期发起选举。</li>
</ol>
<p><strong>读写分离的讨论</strong></p>
<p>官方默认cluster不进行读写分离。在cluster架构下，默认的，一般redis-master用于接收读写，而redis-slave则用于备份，当有请求是向slave发起时，会直接重定向到对应key的master来处理。</p>
<p>可通过readonly命令，将slave设置成可读，然后通过slave获取相关的key，达到读写分离。</p>
<p>不过，通过对master进行水平扩展就可以了，扩容master，跟之前扩容slave并进行读写分离，效果是一样的或者更好。</p>
</article>
    </section>

    
    <section id="content-pager">
        
            <div class="next">
                <a class="card" href="/Blog-With-GitHub-Boilerplate/archives/consistency/">
                    <time>July 14 2021</time>
                    <span>一致性问题</span>
                </a>
            </div>
        
        
            <div class="prev">
                <a class="card" href="/Blog-With-GitHub-Boilerplate/archives/binary_tree/">
                    <time>June 24 2021</time>
                    <span>二叉树的前中后序遍历</span>
                </a>
            </div>
        
    </section>
    

    

    <script>
        document.body.classList.add('content');
        document.body.classList.remove('archive');
    </script>
</div>
                    <footer>
                        <span>Copyright © 2022 君祁</span>
                        
    

                        
                    </footer>
                </div>
                
<aside id="toc-container" class="no-scrollbar">
    <span><i class="fa fa-align-right"></i> CONTENTS</span>
    <div id="toc"></div>
</aside>

            </div>
        </main>


        <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tocbot@4.10.0/dist/tocbot.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
        <script src="/Blog-With-GitHub-Boilerplate/assets/kepler-ef161b04d5.js"></script>
        <script>
            function ExSearchCall(item){
                if (item && item.length) {
                    $('.ins-close').click(); // 关闭搜索框
                    $('input.ins-search-input').val(''); // 清空
                    let url = item.attr('data-url'); // 获取目标页面 URL
                    $.pjax({url: url, 
                        container: '#pjax-container',
                        fragment: '#pjax-container',
                        timeout: 8000, }); // 发起一次 PJAX 请求
                }
            }
        </script>

        <!--Valine-->
        

        <!--ExSearch-->
        <script src="/Blog-With-GitHub-Boilerplate/assets/ExSearch/ExSearch-493cb9cd89.js"></script>
        
        <!--katex-->
        <link rel="stylesheet" href="/Blog-With-GitHub-Boilerplate/assets/katex.min.css">
        <script defer src="/Blog-With-GitHub-Boilerplate/assets/katex.min.js"></script>
        <script>
        mathOpts = {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "\\[", right: "\\]", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false}
            ]
        };
        </script>
        <script defer src="/Blog-With-GitHub-Boilerplate/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

        
    </body>
</html>